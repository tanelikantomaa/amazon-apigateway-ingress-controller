name: Master, build and deploy changes to production ECR

on:
  push:
    branches:
      - master

jobs:
  release_build_push_apigateway_controller:
    runs-on: ubuntu-latest
    name: Build apigateway ingress controller Docker image and push to ECR
    steps:
      - name: Checkout
        uses: actions/checkout@master
        with:
          fetch-depth: '0'
        
      - name: Bump version and push tag
        id: tagging
        if: contains(github.ref, 'master')
        uses: anothrNick/github-tag-action@1.21.0
        env:
          GITHUB_TOKEN: ${{ secrets.ACTION_GITHUB_TOKEN }}
          DEFAULT_BUMP: patch
          INITIAL_VERSION: 1.5.0
          RELEASE_BRANCHES: master

      - name: Build Docker image and Push to ECR
        uses: kciter/aws-ecr-action@v1
        env:
          repo: apigateway-ingress-controller
        with:
          access_key_id: ${{ secrets.CIUSER_AWS_ACCESS_KEY_ID }}
          secret_access_key: ${{ secrets.CIUSER_AWS_SECRET_ACCESS_KEY }}
          account_id: 838837044885
          dockerfile: ./docker/app/Dockerfile
          path: ./
          extra_build_args: {}
          repo: ${{ env.repo }}
          region: eu-central-1
          tags: 1.1.0
          create_repo: false